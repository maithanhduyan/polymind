# Generated by Copilot
from qdrant_client import QdrantClient
from qdrant_client.models import Distance, VectorParams, PointStruct
import os
import shutil
from pathlib import Path

"""
Demo Qdrant vá»›i Persistent Storage (lÆ°u file)
"""


def demo_persistent_storage():
    """Demo Qdrant vá»›i persistent storage"""
    storage_path = "./qdrant_persistent_data"

    # XÃ³a thÆ° má»¥c cÅ© náº¿u cÃ³ Ä‘á»ƒ demo clean
    if os.path.exists(storage_path):
        shutil.rmtree(storage_path)
        print(f"ğŸ—‘ï¸ ÄÃ£ xÃ³a thÆ° má»¥c cÅ©: {storage_path}")

    print(f"ğŸ’¾ Táº¡o Qdrant client vá»›i persistent storage: {storage_path}")
    client = QdrantClient(path=storage_path)

    collection_name = "persistent_collection"

    # Táº¡o collection
    client.create_collection(
        collection_name=collection_name,
        vectors_config=VectorParams(size=4, distance=Distance.COSINE),
    )
    print(f"ğŸ“¦ ÄÃ£ táº¡o collection: {collection_name}")

    # ThÃªm dá»¯ liá»‡u
    points = [
        PointStruct(
            id=1, vector=[0.1, 0.2, 0.3, 0.4], payload={"type": "persistent_point_1"}
        ),
        PointStruct(
            id=2, vector=[0.5, 0.6, 0.7, 0.8], payload={"type": "persistent_point_2"}
        ),
        PointStruct(
            id=3, vector=[0.9, 0.8, 0.7, 0.6], payload={"type": "persistent_point_3"}
        ),
    ]

    client.upsert(collection_name=collection_name, points=points)
    print(f"ğŸ“¤ ÄÃ£ thÃªm {len(points)} Ä‘iá»ƒm vÃ o collection")

    # Kiá»ƒm tra dá»¯ liá»‡u
    search_result = client.search(
        collection_name=collection_name,
        query_vector=[0.1, 0.2, 0.3, 0.4],
        limit=2,
    )

    print("\nğŸ” Káº¿t quáº£ tÃ¬m kiáº¿m:")
    for hit in search_result:
        print(f"  ID: {hit.id}, Score: {hit.score:.4f}, Payload: {hit.payload}")

    # Kiá»ƒm tra files Ä‘Ã£ Ä‘Æ°á»£c táº¡o
    print(f"\nğŸ“ Kiá»ƒm tra files trong {storage_path}:")
    if os.path.exists(storage_path):
        for root, dirs, files in os.walk(storage_path):
            level = root.replace(storage_path, "").count(os.sep)
            indent = " " * 2 * level
            print(f"{indent}{os.path.basename(root)}/")
            subindent = " " * 2 * (level + 1)
            for file in files:
                file_path = os.path.join(root, file)
                file_size = os.path.getsize(file_path)
                print(f"{subindent}{file} ({file_size} bytes)")

    return client, collection_name, storage_path


def demo_load_from_persistent():
    """Demo load dá»¯ liá»‡u tá»« persistent storage"""
    storage_path = "./qdrant_persistent_data"

    if not os.path.exists(storage_path):
        print(f"âŒ KhÃ´ng tÃ¬m tháº¥y persistent data táº¡i: {storage_path}")
        return

    print(f"ğŸ”„ Load dá»¯ liá»‡u tá»« persistent storage: {storage_path}")
    client = QdrantClient(path=storage_path)

    collection_name = "persistent_collection"

    # Kiá»ƒm tra collections cÃ³ sáºµn
    collections = client.get_collections()
    print(f"ğŸ“‹ Collections cÃ³ sáºµn: {[c.name for c in collections.collections]}")

    if collection_name not in [c.name for c in collections.collections]:
        print(f"âŒ Collection {collection_name} khÃ´ng tá»“n táº¡i")
        return

    # Láº¥y táº¥t cáº£ dá»¯ liá»‡u
    all_points = client.scroll(collection_name=collection_name, limit=100)
    print(f"ğŸ“Š Tá»•ng sá»‘ Ä‘iá»ƒm trong collection: {len(all_points[0])}")

    for point in all_points[0]:
        print(f"  ID: {point.id}, Vector: {point.vector}, Payload: {point.payload}")

    # Thá»­ search
    search_result = client.search(
        collection_name=collection_name,
        query_vector=[0.9, 0.8, 0.7, 0.6],
        limit=2,
    )

    print("\nğŸ” Káº¿t quáº£ tÃ¬m kiáº¿m tá»« persistent data:")
    for hit in search_result:
        print(f"  ID: {hit.id}, Score: {hit.score:.4f}, Payload: {hit.payload}")


def run_persistent_demo():
    """Cháº¡y demo persistent storage"""
    print("=" * 60)
    print("ğŸ¯ DEMO 1: Táº¡o vÃ  lÆ°u dá»¯ liá»‡u persistent")
    print("=" * 60)

    client, collection_name, storage_path = demo_persistent_storage()

    print(f"\nâœ… Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ o: {storage_path}")
    print("ğŸ’¡ Báº¡n cÃ³ thá»ƒ táº¯t chÆ°Æ¡ng trÃ¬nh vÃ  cháº¡y láº¡i Ä‘á»ƒ load dá»¯ liá»‡u")

    print("\n" + "=" * 60)
    print("ğŸ¯ DEMO 2: Load dá»¯ liá»‡u tá»« persistent storage")
    print("=" * 60)

    demo_load_from_persistent()

    print(f"\nâœ… Demo persistent storage hoÃ n thÃ nh!")


if __name__ == "__main__":
    run_persistent_demo()
