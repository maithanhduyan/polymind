# Generated by Copilot
# PolyMind System Lifecycle - Enhanced Safety Architecture

## ğŸ”„ Server Startup Flow vá»›i Safety Improvements

```mermaid
flowchart TD
    A[ğŸš€ Server Start Request] --> B{Validate Environment}
    
    B --> B1[Check Python Version â‰¥3.8]
    B --> B2[Verify Working Directory]
    B --> B3[Check Project Structure]
    B --> B4[Validate Dependencies]
    
    B1 --> C{Environment OK?}
    B2 --> C
    B3 --> C
    B4 --> C
    
    C -->|âŒ Failed| Z1[âŒ Exit with Error Message]
    C -->|âœ… OK| D[Setup Signal Handlers]
    
    D --> E[Parse Command Line Arguments]
    E --> F{Check Port Availability}
    
    F -->|Port Available| G[Import FastAPI App]
    F -->|Port Busy| H{Auto-Recovery Options}
    
    H --> H1{--auto-kill?}
    H --> H2{--auto-port?}
    
    H1 -->|Yes| I1[Kill Processes on Port]
    H1 -->|No| H2
    
    I1 --> I2[Wait 2 seconds]
    I2 --> F
    
    H2 -->|Yes| J1[Find Next Available Port]
    H2 -->|No| Z2[âŒ Port Conflict Error]
    
    J1 --> J2[Update Port Configuration]
    J2 --> G
    
    G --> G1{Import Strategy}
    G1 --> G2[Try Relative Import]
    G2 -->|Success| K[Configure Uvicorn]
    G2 -->|Failed| G3[Try Absolute Import]
    G3 -->|Success| K
    G3 -->|Failed| Z3[âŒ Import Error]
    
    K --> L[Start Uvicorn Server]
    L --> M{Server Started?}
    
    M -->|âœ… Success| N[ğŸ‰ Server Running]
    M -->|âŒ Failed| O{Error Type}
    
    O --> O1[Port Still Busy]
    O --> O2[Permission Error] 
    O --> O3[Configuration Error]
    
    O1 --> Z4[âŒ Retry with Different Port]
    O2 --> Z5[âŒ Permission Denied]
    O3 --> Z6[âŒ Config Error]
    
    N --> P[Monitor Health]
    P --> Q{Signal Received?}
    
    Q -->|SIGINT/SIGTERM| R[Graceful Shutdown]
    Q -->|No| P
    
    R --> S[Cleanup Resources]
    S --> T[ğŸ›‘ Server Stopped]
    
    style A fill:#e1f5fe
    style N fill:#c8e6c9
    style T fill:#ffcdd2
    style Z1 fill:#ffcdd2
    style Z2 fill:#ffcdd2
    style Z3 fill:#ffcdd2
    style Z4 fill:#ffcdd2
    style Z5 fill:#ffcdd2
    style Z6 fill:#ffcdd2
```

## ğŸ” Port Management Flow

```mermaid
flowchart LR
    A[Check Port 8000] --> B{Available?}
    
    B -->|âœ… Yes| C[Use Port 8000]
    B -->|âŒ No| D{--auto-kill?}
    
    D -->|Yes| E[Scan Processes]
    D -->|No| F{--auto-port?}
    
    E --> E1[Find Process Using Port]
    E1 --> E2[Terminate Process]
    E2 --> E3[Wait 2s]
    E3 --> A
    
    F -->|Yes| G[Try Port 8001]
    F -->|No| H[âŒ Exit: Port Busy]
    
    G --> I{Available?}
    I -->|âœ… Yes| J[Use Port 8001]
    I -->|âŒ No| K[Try Port 8002]
    
    K --> L{Available?}
    L -->|âœ… Yes| M[Use Port 8002]
    L -->|âŒ No| N[Continue Scanning...]
    
    style C fill:#c8e6c9
    style J fill:#c8e6c9
    style M fill:#c8e6c9
    style H fill:#ffcdd2
```

## ğŸ›¡ï¸ Error Handling Matrix

```mermaid
flowchart TD
    A[Error Detected] --> B{Error Category}
    
    B --> C[Environment Error]
    B --> D[Import Error]
    B --> E[Port Error]
    B --> F[Runtime Error]
    
    C --> C1[Log Error Details]
    C --> C2[Show Fix Suggestions]
    C --> C3[Exit Code 1]
    
    D --> D1[Try Fallback Import]
    D1 --> D2{Success?}
    D2 -->|Yes| D3[Continue Startup]
    D2 -->|No| D4[Exit with Import Guide]
    
    E --> E1{Auto-Recovery Enabled?}
    E1 -->|Yes| E2[Apply Auto-Fix]
    E1 -->|No| E3[Manual Fix Required]
    
    E2 --> E4[Retry Operation]
    E3 --> E5[Show Solutions]
    
    F --> F1[Log Stack Trace]
    F --> F2[Graceful Shutdown]
    F --> F3[Exit Code 1]
    
    style D3 fill:#c8e6c9
    style E2 fill:#c8e6c9
    style C3 fill:#ffcdd2
    style D4 fill:#ffcdd2
    style E5 fill:#fff3e0
    style F3 fill:#ffcdd2
```

## ğŸ”„ Application Lifecycle States

```mermaid
stateDiagram-v2
    [*] --> Starting
    
    Starting --> Validating : Environment Check
    Starting --> Failed : Validation Error
    
    Validating --> Importing : All Checks Pass
    Validating --> Failed : Check Failed
    
    Importing --> Configuring : App Imported
    Importing --> Recovering : Import Failed
    
    Recovering --> Importing : Fallback Success
    Recovering --> Failed : All Imports Failed
    
    Configuring --> Binding : Config Ready
    Configuring --> Failed : Config Error
    
    Binding --> Running : Port Bound
    Binding --> PortConflict : Port Busy
    
    PortConflict --> AutoKill : --auto-kill enabled
    PortConflict --> AutoPort : --auto-port enabled
    PortConflict --> Failed : Manual intervention needed
    
    AutoKill --> Binding : Process killed
    AutoPort --> Binding : Alternative port found
    
    Running --> Monitoring : Server Started
    
    Monitoring --> Monitoring : Health OK
    Monitoring --> Shutting : Signal Received
    Monitoring --> Failed : Critical Error
    
    Shutting --> Cleanup : Graceful Shutdown
    Cleanup --> Stopped : Resources Released
    
    Failed --> [*]
    Stopped --> [*]
    
    note right of Running
        ğŸ‰ Server is healthy and 
        serving requests
    end note
    
    note right of PortConflict
        ğŸ”§ Auto-recovery features
        attempt to resolve conflicts
    end note
```

## ğŸš¦ Command Line Options Impact

```mermaid
flowchart LR
    A[Command Flags] --> B{--auto-port}
    A --> C{--auto-kill}
    A --> D{--prod}
    A --> E{--no-reload}
    
    B -->|Enabled| B1[ğŸ” Find Alternative Port]
    B -->|Disabled| B2[âŒ Fail on Port Conflict]
    
    C -->|Enabled| C1[âš”ï¸ Kill Conflicting Process]
    C -->|Disabled| C2[âš ï¸ Manual Resolution]
    
    D -->|Enabled| D1[ğŸ­ Production Mode]
    D -->|Disabled| D2[ğŸ”§ Development Mode]
    
    D1 --> D3[No Reload + Optimized]
    D2 --> D4[Auto-reload + Debug]
    
    E -->|Enabled| E1[ğŸ“‹ Static Mode]
    E -->|Disabled| E2[ğŸ”„ Watch Files]
    
    style B1 fill:#c8e6c9
    style C1 fill:#fff3e0
    style D1 fill:#e3f2fd
    style E1 fill:#f3e5f5
    style B2 fill:#ffcdd2
    style C2 fill:#ffcdd2
```

## ğŸ“Š Safety Improvements Summary

### âœ… Before vs After

| Aspect | Before | After | Improvement |
|--------|--------|-------|-------------|
| Port Conflicts | âŒ Hard crash | âœ… Auto-recovery | ğŸ”¥ **Major** |
| Import Issues | âš ï¸ Warnings | âœ… Multiple strategies | ğŸ”¥ **Major** |
| Error Messages | âŒ Cryptic | âœ… Clear + solutions | ğŸ”¥ **Major** |
| Environment | âŒ No validation | âœ… Comprehensive check | ğŸ†• **New** |
| Process Mgmt | âŒ Manual | âœ… Automatic | ğŸ†• **New** |
| Logging | âš ï¸ Basic prints | âœ… Structured logging | ğŸ”¥ **Major** |
| Signal Handling | âŒ None | âœ… Graceful shutdown | ğŸ†• **New** |

### ğŸ¯ Key Benefits

1. **ğŸ›¡ï¸ Reliability**: Server always finds a way to start
2. **ğŸ”§ Self-Healing**: Automatic conflict resolution  
3. **ğŸ“‹ Transparency**: Clear logging and error messages
4. **ğŸš€ Developer Experience**: Less manual intervention
5. **ğŸ­ Production Ready**: Robust error handling

### ğŸ”§ Usage Examples

```bash
# Maximum safety - auto-recovery enabled
python -m backend.main --auto-port --auto-kill

# Production mode with port management
python -m backend.main --prod --auto-port

# Development with conflict resolution
python -m backend.main --auto-kill
```

---

*Diagram nÃ y minh há»a toÃ n bá»™ system lifecycle vá»›i cÃ¡c cáº£i tiáº¿n safety má»›i Ä‘Æ°á»£c thÃªm vÃ o PolyMind server.*
