# Generated by Copilot
# PolyMind System Lifecycle - Enhanced Safety Architecture

## 🔄 Server Startup Flow với Safety Improvements

```mermaid
flowchart TD
    A[🚀 Server Start Request] --> B{Validate Environment}
    
    B --> B1[Check Python Version ≥3.8]
    B --> B2[Verify Working Directory]
    B --> B3[Check Project Structure]
    B --> B4[Validate Dependencies]
    
    B1 --> C{Environment OK?}
    B2 --> C
    B3 --> C
    B4 --> C
    
    C -->|❌ Failed| Z1[❌ Exit with Error Message]
    C -->|✅ OK| D[Setup Signal Handlers]
    
    D --> E[Parse Command Line Arguments]
    E --> F{Check Port Availability}
    
    F -->|Port Available| G[Import FastAPI App]
    F -->|Port Busy| H{Auto-Recovery Options}
    
    H --> H1{--auto-kill?}
    H --> H2{--auto-port?}
    
    H1 -->|Yes| I1[Kill Processes on Port]
    H1 -->|No| H2
    
    I1 --> I2[Wait 2 seconds]
    I2 --> F
    
    H2 -->|Yes| J1[Find Next Available Port]
    H2 -->|No| Z2[❌ Port Conflict Error]
    
    J1 --> J2[Update Port Configuration]
    J2 --> G
    
    G --> G1{Import Strategy}
    G1 --> G2[Try Relative Import]
    G2 -->|Success| K[Configure Uvicorn]
    G2 -->|Failed| G3[Try Absolute Import]
    G3 -->|Success| K
    G3 -->|Failed| Z3[❌ Import Error]
    
    K --> L[Start Uvicorn Server]
    L --> M{Server Started?}
    
    M -->|✅ Success| N[🎉 Server Running]
    M -->|❌ Failed| O{Error Type}
    
    O --> O1[Port Still Busy]
    O --> O2[Permission Error] 
    O --> O3[Configuration Error]
    
    O1 --> Z4[❌ Retry with Different Port]
    O2 --> Z5[❌ Permission Denied]
    O3 --> Z6[❌ Config Error]
    
    N --> P[Monitor Health]
    P --> Q{Signal Received?}
    
    Q -->|SIGINT/SIGTERM| R[Graceful Shutdown]
    Q -->|No| P
    
    R --> S[Cleanup Resources]
    S --> T[🛑 Server Stopped]
    
    style A fill:#e1f5fe
    style N fill:#c8e6c9
    style T fill:#ffcdd2
    style Z1 fill:#ffcdd2
    style Z2 fill:#ffcdd2
    style Z3 fill:#ffcdd2
    style Z4 fill:#ffcdd2
    style Z5 fill:#ffcdd2
    style Z6 fill:#ffcdd2
```

## 🔍 Port Management Flow

```mermaid
flowchart LR
    A[Check Port 8000] --> B{Available?}
    
    B -->|✅ Yes| C[Use Port 8000]
    B -->|❌ No| D{--auto-kill?}
    
    D -->|Yes| E[Scan Processes]
    D -->|No| F{--auto-port?}
    
    E --> E1[Find Process Using Port]
    E1 --> E2[Terminate Process]
    E2 --> E3[Wait 2s]
    E3 --> A
    
    F -->|Yes| G[Try Port 8001]
    F -->|No| H[❌ Exit: Port Busy]
    
    G --> I{Available?}
    I -->|✅ Yes| J[Use Port 8001]
    I -->|❌ No| K[Try Port 8002]
    
    K --> L{Available?}
    L -->|✅ Yes| M[Use Port 8002]
    L -->|❌ No| N[Continue Scanning...]
    
    style C fill:#c8e6c9
    style J fill:#c8e6c9
    style M fill:#c8e6c9
    style H fill:#ffcdd2
```

## 🛡️ Error Handling Matrix

```mermaid
flowchart TD
    A[Error Detected] --> B{Error Category}
    
    B --> C[Environment Error]
    B --> D[Import Error]
    B --> E[Port Error]
    B --> F[Runtime Error]
    
    C --> C1[Log Error Details]
    C --> C2[Show Fix Suggestions]
    C --> C3[Exit Code 1]
    
    D --> D1[Try Fallback Import]
    D1 --> D2{Success?}
    D2 -->|Yes| D3[Continue Startup]
    D2 -->|No| D4[Exit with Import Guide]
    
    E --> E1{Auto-Recovery Enabled?}
    E1 -->|Yes| E2[Apply Auto-Fix]
    E1 -->|No| E3[Manual Fix Required]
    
    E2 --> E4[Retry Operation]
    E3 --> E5[Show Solutions]
    
    F --> F1[Log Stack Trace]
    F --> F2[Graceful Shutdown]
    F --> F3[Exit Code 1]
    
    style D3 fill:#c8e6c9
    style E2 fill:#c8e6c9
    style C3 fill:#ffcdd2
    style D4 fill:#ffcdd2
    style E5 fill:#fff3e0
    style F3 fill:#ffcdd2
```

## 🔄 Application Lifecycle States

```mermaid
stateDiagram-v2
    [*] --> Starting
    
    Starting --> Validating : Environment Check
    Starting --> Failed : Validation Error
    
    Validating --> Importing : All Checks Pass
    Validating --> Failed : Check Failed
    
    Importing --> Configuring : App Imported
    Importing --> Recovering : Import Failed
    
    Recovering --> Importing : Fallback Success
    Recovering --> Failed : All Imports Failed
    
    Configuring --> Binding : Config Ready
    Configuring --> Failed : Config Error
    
    Binding --> Running : Port Bound
    Binding --> PortConflict : Port Busy
    
    PortConflict --> AutoKill : --auto-kill enabled
    PortConflict --> AutoPort : --auto-port enabled
    PortConflict --> Failed : Manual intervention needed
    
    AutoKill --> Binding : Process killed
    AutoPort --> Binding : Alternative port found
    
    Running --> Monitoring : Server Started
    
    Monitoring --> Monitoring : Health OK
    Monitoring --> Shutting : Signal Received
    Monitoring --> Failed : Critical Error
    
    Shutting --> Cleanup : Graceful Shutdown
    Cleanup --> Stopped : Resources Released
    
    Failed --> [*]
    Stopped --> [*]
    
    note right of Running
        🎉 Server is healthy and 
        serving requests
    end note
    
    note right of PortConflict
        🔧 Auto-recovery features
        attempt to resolve conflicts
    end note
```

## 🚦 Command Line Options Impact

```mermaid
flowchart LR
    A[Command Flags] --> B{--auto-port}
    A --> C{--auto-kill}
    A --> D{--prod}
    A --> E{--no-reload}
    
    B -->|Enabled| B1[🔍 Find Alternative Port]
    B -->|Disabled| B2[❌ Fail on Port Conflict]
    
    C -->|Enabled| C1[⚔️ Kill Conflicting Process]
    C -->|Disabled| C2[⚠️ Manual Resolution]
    
    D -->|Enabled| D1[🏭 Production Mode]
    D -->|Disabled| D2[🔧 Development Mode]
    
    D1 --> D3[No Reload + Optimized]
    D2 --> D4[Auto-reload + Debug]
    
    E -->|Enabled| E1[📋 Static Mode]
    E -->|Disabled| E2[🔄 Watch Files]
    
    style B1 fill:#c8e6c9
    style C1 fill:#fff3e0
    style D1 fill:#e3f2fd
    style E1 fill:#f3e5f5
    style B2 fill:#ffcdd2
    style C2 fill:#ffcdd2
```

## 📊 Safety Improvements Summary

### ✅ Before vs After

| Aspect | Before | After | Improvement |
|--------|--------|-------|-------------|
| Port Conflicts | ❌ Hard crash | ✅ Auto-recovery | 🔥 **Major** |
| Import Issues | ⚠️ Warnings | ✅ Multiple strategies | 🔥 **Major** |
| Error Messages | ❌ Cryptic | ✅ Clear + solutions | 🔥 **Major** |
| Environment | ❌ No validation | ✅ Comprehensive check | 🆕 **New** |
| Process Mgmt | ❌ Manual | ✅ Automatic | 🆕 **New** |
| Logging | ⚠️ Basic prints | ✅ Structured logging | 🔥 **Major** |
| Signal Handling | ❌ None | ✅ Graceful shutdown | 🆕 **New** |

### 🎯 Key Benefits

1. **🛡️ Reliability**: Server always finds a way to start
2. **🔧 Self-Healing**: Automatic conflict resolution  
3. **📋 Transparency**: Clear logging and error messages
4. **🚀 Developer Experience**: Less manual intervention
5. **🏭 Production Ready**: Robust error handling

### 🔧 Usage Examples

```bash
# Maximum safety - auto-recovery enabled
python -m backend.main --auto-port --auto-kill

# Production mode with port management
python -m backend.main --prod --auto-port

# Development with conflict resolution
python -m backend.main --auto-kill
```

---

*Diagram này minh họa toàn bộ system lifecycle với các cải tiến safety mới được thêm vào PolyMind server.*
